name: oio-sds
version: v2.0
workflow:
  build:
    depends_on:
    - root
    conditions:
      check:
      - variable: cds.triggered_by.username
        operator: ne
        value: cds.scheduler
    pipeline: oio-sds-build
    application: oio-sds
  coverage:
    depends_on:
    - tests-3copies
    - tests-cli
    - tests-fast
    - tests-single
    pipeline: oio-sds-coverage
  mirror:
    depends_on:
    - root
    pipeline: oio-sds-mirror
    application: oio-sds
  root:
    pipeline: oio-sds-root
    application: oio-sds
    payload:
      git.author: ""
      git.branch: master
      git.hash: ""
      git.hash.before: ""
      git.message: ""
      git.repository: OPENIO/oio-sds
      git.tag: ""
  tests-3copies:
    depends_on:
    - tests-fast
    conditions:
      check:
      - variable: cds.triggered_by.username
        operator: ne
        value: cds.scheduler
    pipeline: oio-sds-test-functional
    application: oio-sds
    environment: oio-sds-env-3copies
  tests-cli:
    depends_on:
    - tests-fast
    conditions:
      check:
      - variable: cds.triggered_by.username
        operator: ne
        value: cds.scheduler
    pipeline: oio-sds-test-functional
    application: oio-sds
    environment: oio-sds-env-cli
  tests-fast:
    depends_on:
    - root
    conditions:
      check:
      - variable: cds.triggered_by.username
        operator: ne
        value: cds.scheduler
    pipeline: oio-sds-test-fast
    application: oio-sds
    environment: oio-sds-env-test-fast
  tests-single:
    depends_on:
    - root
    conditions:
      check:
      - variable: cds.triggered_by.username
        operator: ne
        value: cds.scheduler
    pipeline: oio-sds-test-functional
    application: oio-sds
    environment: oio-sds-env-single
hooks:
  root:
  - type: Scheduler
    config:
      cron: 7 * * * *
      payload: |-
        {
          "git.author": "",
          "git.branch": "master",
          "git.hash": "",
          "git.hash.before": "",
          "git.message": "",
          "git.repository": "OPENIO/oio-sds",
          "git.tag": ""
        }
      timezone: UTC
  - type: RepositoryWebHook
    config:
      eventFilter: repo:refs_changed
metadata:
  default_tags: git.branch,git.author,git.tag
retention_policy: "-- Keep Run for 365 days if git_branch is set and exists in VCS or only 2 days for removed branches\n-- Else keep Run for 365 days if no git_branch info is set\nif(cds_triggered_by_username == 'cds.scheduler') then\n  return run_days_before < 1\nend\nif(has_git_branch == \"true\") then\n  if(git_branch_exist == \"true\") then\n    return run_days_before < 365\n  else\n    return run_days_before < 2\n  end\nelse \n  return run_days_before < 365\nend\n\n\n\n"
notifications:
- type: vcs
  settings:
    on_success: always
